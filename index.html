<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¬¸ì œì§‘ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜</title>
<style>
/* ì¢Œìš° ìŠ¤í¬ë¡¤ ì°¨ë‹¨ & ë°•ìŠ¤ì‚¬ì´ì§• í†µì¼ */
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow-x:hidden;-webkit-text-size-adjust:100%}

/* ëª¨ë…¸í†¤ Apple-like í† í° */
:root{
  --bg:#ffffff; --fg:#1d1d1f; --muted:#6e6e73; --line:#d2d2d7; --elev:#f5f5f7;
  --cta:#1d1d1f;  /* ëª¨ë…¸í†¤ í¬ì¸íŠ¸(ê²€ì •) */
  --radius:20px; --space:22px; --shadow:0 14px 40px rgba(0,0,0,.08);
  --ease:cubic-bezier(.25,.46,.45,.94); --speed:.28s;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Noto Sans KR",system-ui,Segoe UI,Roboto,sans-serif;
  color:var(--fg); background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding: clamp(18px, 4vw, 36px);
}

/* ì•± ì¹´ë“œ */
.chat{ width:min(480px,94vw); height:min(680px,92vh); background:#fff; border:1px solid var(--line);
  border-radius:var(--radius); box-shadow:var(--shadow);
  display:flex; flex-direction:column; overflow:hidden; transition:opacity .6s var(--ease) }
.fade-out{opacity:0;pointer-events:none}

.header{ padding: calc(var(--space) - 4px) var(--space) var(--space); border-bottom:1px solid var(--line) }
.title{ margin:0; font-size:22px; font-weight:600; letter-spacing:-.02em; text-align:center }

/* ë³¸ë¬¸ */
#chat-content{ flex:1; padding: var(--space); overflow-y:auto; overflow-x:hidden; scroll-behavior:smooth }
h3{margin:0 0 14px 0; font-size:18px; font-weight:600; text-align:center}
.p{margin:0; color:var(--muted); font-size:16.5px}

/* ë²„íŠ¼ */
.button{ display:block; width:100%; border:1px solid var(--line); background:var(--elev); color:var(--fg);
  border-radius:14px; padding:14px 16px; font-size:17px; font-weight:600; letter-spacing:-.01em; margin:10px 0;
  transition:transform var(--speed) var(--ease), filter var(--speed) var(--ease), background var(--speed) var(--ease); cursor:pointer }
.button:hover{ transform:translateY(-1px); filter:brightness(1.02) }
.button:active{ transform:translateY(0); filter:brightness(.98) }
.button.cta{ background:var(--cta); color:#fff; border-color:var(--cta) }

/* í•˜ë‹¨ë°”: 3ë²„íŠ¼ ê· ë“± */
.bottom{ display:flex; gap:10px; padding: var(--space); border-top:1px solid var(--line) }
.bottom .button{ margin:0; flex:1; min-width:0 }

/* ì¹´ë“œí˜• ì•„ì´í…œ(ì¶”ì²œ ë¦¬ìŠ¤íŠ¸) */
.card{ background:var(--elev); border:1px solid var(--line); border-radius:14px; padding:10px 12px; font-size:16px; margin:8px 0 }

/* ë§Œì¡±ë„(ë¼ë””ì˜¤+ë¼ë²¨) */
.rating{ display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-top:12px; justify-items:center; align-items:center }
.rating input{ position:absolute; opacity:0; width:0; height:0 }
.emoji{ font-size:2.2rem; line-height:1; display:inline-block; cursor:pointer; transform:scale(1);
  transition:transform .2s var(--ease), filter .2s var(--ease) }
.rating input:checked + .emoji{ transform:scale(1.24); filter:drop-shadow(0 0 6px rgba(0,0,0,.25)) }
@keyframes bounce{0%{transform:scale(1)}35%{transform:scale(1.34)}70%{transform:scale(0.92)}100%{transform:scale(1.24)}}
.pulse{ animation:bounce .32s var(--ease) }

/* í…ìŠ¤íŠ¸ ì˜ì—­ */
textarea{ width:100%; max-width:100%; border:1px solid var(--line); background:#fff; border-radius:12px;
  padding:12px; font-size:16px; line-height:1.5; resize:none; color:var(--fg) }

/* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬(ëª¨ë…¸í†¤, ì¢Œìš°ëŒ€ì¹­ ë²„íŠ¼, Enter=í™•ì¸) */
.modal{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.4); align-items:center; justify-content:center; padding:16px }
.modal-box{ width:min(380px,94vw); background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:18px }
.modal h4{ margin:0 0 12px 0; font-size:18px; text-align:center; font-weight:600 }
.input{ width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:16px; text-align:center }
.modal-row{ display:flex; gap:10px; margin-top:12px }
.modal-row .button{ margin:0; flex:1 }
</style>
</head>
<body>
  <div class="chat" id="chatBox">
    <div class="header"><h1 class="title">ë¬¸ì œì§‘ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜</h1></div>

    <div id="chat-content"></div>

    <div class="bottom">
      <button class="button" id="backBtn">â† ë˜ëŒì•„ê°€ê¸°</button>
      <button class="button" id="homeBtn">âŒ‚ ì²˜ìŒìœ¼ë¡œ</button>
      <button class="button" id="heartBtn">ğŸ’–</button>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div class="modal" id="passwordModal" aria-modal="true" role="dialog">
    <div class="modal-box">
      <h4>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h4>
      <input id="adminPass" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
      <div class="modal-row">
        <button class="button cta" id="pwConfirmBtn">í™•ì¸</button>
        <button class="button" id="pwCancelBtn">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

<script>
/* ===== ì„¤ì • ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzT8R_3RBSfBZvxovrYzdDw9Uk1And-2aNC4WJzYnZhPNfHNcEomJEPgngMfaWzpFB/exec";
/* í‰ë¬¸ ëŒ€ì‹  SHA-256 í•´ì‹œë§Œ ì½”ë“œì— ë³´ê´€ (ë¹„ë²ˆ 0411ì˜ í•´ì‹œ) */
const ADMIN_PW_SHA256 = "d20bdc364b3d7dfdcd81be5a3fd192d0f513fa79e92463bf0ed9efd2f46c243b";

/* ===== ì„¸ì…˜ ë° ë°©ë¬¸ ë¡œê·¸ ===== */
if(!localStorage.getItem("sessionId")) localStorage.setItem("sessionId","sess-"+Math.random().toString(36).slice(2,11));
const SESSION_ID = localStorage.getItem("sessionId");
fetch(`${SCRIPT_URL}?action=visit&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});

/* ===== ë°ì´í„° ===== */
const data = {
  "ê°œë…ì„œ": {
    1:["ìˆ˜í•™ì˜ ë°”ì´ë¸”","ë§ˆí”Œ êµê³¼ì„œ","ìˆ˜í•™ì˜ ì™•ë„","ì˜¬ë¦¼í¬ìŠ¤ ìˆ˜í•™","ê°œë… í”ŒëŸ¬ìŠ¤ ìœ í˜• ê³ ë“± ìˆ˜í•™","ì´ìœ ìˆëŠ” ìˆ˜í•™ ê°œë… SOS","ì…€íŒŒ í•´ë²•ìˆ˜í•™"],
    2:["ìˆ˜í•™ì˜ ìƒ˜","ê°œë… ìˆ","í’ì‚°ì","ê°œë…ì›ë¦¬"],
    3:["ê¸°ë³¸ ìˆ˜í•™ì˜ ì •ì„","ìˆ˜í•™ì¤‘ì‹¬ ê³ ë“±ìˆ˜í•™","ë©”ê°€ìŠ¤í„°ë”” ë¬¸ì œ ê¸°ë³¸ì„œ CPRìˆ˜í•™","ë” ê°œë… ë¸”ë™ë¼ë²¨"],
    4:["ì‹¤ë ¥ ìˆ˜í•™ì˜ ì •ì„","ìˆ¨ë§ˆì¿°ë¼ìš°ë°"]
  },
  "ìœ í˜• ì‹¬í™”ì„œ": {
    1:["ìˆ˜ë ¥ì¶©ì „","ìˆ˜í•™ì˜ ë°”ì´ë¸” BOB","ê°œë… í”ŒëŸ¬ìŠ¤ ìœ í˜• ë¼ì´íŠ¸","ë¼ì´íŠ¸ ìˆ","ìœ í˜• í•´ê²°ì˜ ë²•ì¹™","ì˜¬ë¦¼í¬ìŠ¤ ë‹¥í„°ë§"],
    2:["ê°œë…ì›ë¦¬ RPM","í’ì‚°ì í•„ìˆ˜ìœ í˜•","ë‚´ê³µì˜ í˜","ì˜¬ë¦¬ë“œ","í•˜ì´ë¼ì´íŠ¸ ë‹¨ê¸° íŠ¹ê°•","ì‹¬í”Œ ìì´ìŠ¤í† ë¦¬"],
    3:["ìˆ ìˆ˜í•™","ë§ˆí”Œ ì‹œë„ˆì§€","ì¼ë“±ê¸‰ ìˆ˜í•™","1ë“±ê¸‰ ë§Œë“¤ê¸°"],
    4:["ì¼í’ˆ","ìš¸ë¦¼í¬ìŠ¤ ê³ ë‚œë„","ìˆ˜ëŠ¥ë‹¤í","ì ˆëŒ€ë“±ê¸‰","ìœ í˜•+ë‚´ì‹  ê³ ìŸì´","ë¸”ë™ë¼ë²¨","ë‚´ì‹  í•˜ì´ì•¤ë“œ","í˜„ìš°ì§„ ë‰´ëŸ°-ì‹œëƒ…ìŠ¤","ìˆ˜í•™ì˜ ì‹ "],
    5:["TOT","531 í•˜ì´í¼","ì ˆëŒ€ë“±ê¸‰ ì½”ë“œì— ","í˜„ìš°ì§„ ë“œë¦´"]
  },
  "ê¸°ì¶œ": ["ìì´ìŠ¤í† ë¦¬","ì§± ì–´ë ¤ìš´ ìœ í˜• ê³ ë‚œë„ 4ì ì§œë¦¬ ìˆ˜í•™","ë„ˆí¬ë“¤ì˜ ê¸°ì¶œë¬¸ì œ","ë§ˆí”Œ ìˆ˜ëŠ¥ê¸°ì¶œì´ì •ë¦¬","ìˆ˜ëŠ¥ ê¸°ì¶œì˜ ë°”ì´ë¸”","ì‹¤ì „+ìˆ˜ëŠ¥ ê³ ìŸì´","ì–´ì‚¼ì‰¬ì‚¬","ë„ˆê¸°ì¶œ","ìˆ˜ëŠ¥ ê¸°ì¶œì˜ ë¯¸ë˜","ìˆ ê¸°ì¶œ","í‹°ì˜¤í”¼ í´ë˜ìŠ¤ ìˆ˜ëŠ¥ ê¸°ì¶œë¬¸ì œì§‘","ì´ë™í›ˆ ê¸°ì¶œë¬¸ì œì§‘","ë‹´ê¸ˆì§ˆ","ë°±ë¯¸","ê¸°ì¶œì˜ ê³ ë°±","ë§ˆë”í……","ì˜¬ë¦¼í¬ìŠ¤ ê¸°ì¶œë¬¸ì œì§‘"]
};

/* ===== ìƒíƒœ ===== */
let satisfaction = "", selectedType = "", selectedLevel = "", currentPage = "home";

/* ===== ìœ í‹¸ ===== */
const $ = id => document.getElementById(id);
const chat = () => $("chat-content");
const scrollTop = () => { chat().scrollTop=0; };
const scrollBottom = () => { chat().scrollTop=chat().scrollHeight; };

/* ===== í™”ë©´ ë Œë”ë§ ===== */
function viewHome(){
  currentPage="home"; satisfaction="";
  chat().innerHTML = `
    <div>
      <p class="p" style="text-align:center;margin-bottom:14px">ì›í•˜ëŠ” ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</p>
      <button class="button" onclick="viewType('ê°œë…ì„œ')">ê°œë…ì„œ</button>
      <button class="button" onclick="viewType('ìœ í˜• ì‹¬í™”ì„œ')">ìœ í˜• ì‹¬í™”ì„œ</button>
      <button class="button" onclick="viewType('ê¸°ì¶œ')">ê¸°ì¶œ</button>
    </div>`;
  scrollTop();
}

function viewType(t){
  currentPage="type"; selectedType=t;
  // ì„ íƒ ë¡œê·¸
  fetch(`${SCRIPT_URL}?action=select&type=${encodeURIComponent(t)}&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});
  if(t==="ê°œë…ì„œ"){
    chat().innerHTML = `<h3>${t} ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>` + [1,2,3,4].map(i=>`<button class="button" onclick="viewResult(${i})">${i}ë‹¨ê³„</button>`).join('');
  }else if(t==="ìœ í˜• ì‹¬í™”ì„œ"){
    chat().innerHTML = `<h3>${t} ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>` + [1,2,3,4,5].map(i=>`<button class="button" onclick="viewResult(${i})">${i}ë‹¨ê³„</button>`).join('');
  }else{ // ê¸°ì¶œ
    viewResult();
  }
  scrollTop();
}

function viewResult(lv){
  currentPage="result"; selectedLevel=lv||""; satisfaction="";
  // ë‚œì´ë„ ì„ íƒ ë¡œê·¸(ê¸°ì¶œì€ level ë¯¸ì „ì†¡)
  if(selectedType!=="ê¸°ì¶œ"){
    fetch(`${SCRIPT_URL}?action=select&type=${encodeURIComponent(selectedType)}&level=${encodeURIComponent(selectedLevel)}&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});
  }
  const books = (selectedType==="ê¸°ì¶œ")? data["ê¸°ì¶œ"] : data[selectedType][selectedLevel];
  chat().innerHTML = `
    <div>
      <h3>ì¶”ì²œ ë¬¸ì œì§‘</h3>
      ${books.map(b=>`<div class="card">${b}</div>`).join('')}
      <button class="button cta" id="evalBtn">í‰ê°€í•˜ê¸°</button>
    </div>`;
  $("evalBtn").onclick = openEvaluation;
  scrollTop();
}

/* ===== í‰ê°€ ì˜ì—­ ===== */
function openEvaluation(){
  if($("evalSection")){ $("evalSection").scrollIntoView({behavior:'smooth',block:'start'}); return; }
  chat().insertAdjacentHTML('beforeend', `
    <div id="evalSection" style="margin-top:14px">
      <h3>ë§Œì¡±ë„ ì„ íƒ</h3>
      <div class="rating" id="ratingGroup">
        <input id="r1" type="radio" name="s" value="ë¶ˆë§Œì¡±"><label class="emoji" for="r1" title="ë¶ˆë§Œì¡±">ğŸ˜¡</label>
        <input id="r2" type="radio" name="s" value="ì¡°ê¸ˆ ë¶ˆë§Œì¡±"><label class="emoji" for="r2" title="ì¡°ê¸ˆ ë¶ˆë§Œì¡±">ğŸ˜•</label>
        <input id="r3" type="radio" name="s" value="ë³´í†µ"><label class="emoji" for="r3" title="ë³´í†µ">ğŸ˜</label>
        <input id="r4" type="radio" name="s" value="ë§Œì¡±"><label class="emoji" for="r4" title="ë§Œì¡±">ğŸ™‚</label>
        <input id="r5" type="radio" name="s" value="ë§¤ìš° ë§Œì¡±"><label class="emoji" for="r5" title="ë§¤ìš° ë§Œì¡±">ğŸ˜</label>
      </div>
      <div style="margin-top:12px">
        <textarea id="reviewText" rows="3" placeholder="ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
        <button class="button cta" style="margin-top:10px" onclick="submitReview()">ì œì¶œ</button>
      </div>
    </div>
  `);
  const radios=[...document.querySelectorAll('input[name="s"]')];
  const pulse=id=>{ const l=document.querySelector(`label[for="${id}"]`); l.classList.remove('pulse'); void l.offsetWidth; l.classList.add('pulse'); };
  radios.forEach(r=>{ r.addEventListener('change',e=>{ satisfaction=e.target.value; pulse(e.target.id); }); });
  document.querySelectorAll('.emoji').forEach(l=>{ l.addEventListener('click',()=>{ const id=l.getAttribute('for'); setTimeout(()=>pulse(id),0); }); });
  scrollBottom(); // í‰ê°€ ì—´ë©´ í•˜ë‹¨ìœ¼ë¡œ
}

/* ì œì¶œ â†’ fade-out í›„ í™ˆ */
async function submitReview(){
  const text = ($("reviewText")?.value||"").trim();
  if(!satisfaction) return alert("ë§Œì¡±ë„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
  if(!text) return alert("ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
  try{
    await fetch(`${SCRIPT_URL}?action=review&type=${encodeURIComponent(selectedType)}&level=${encodeURIComponent(selectedLevel)}&review=${encodeURIComponent("["+satisfaction+"] "+text)}&session=${encodeURIComponent(SESSION_ID)}`);
  }catch(e){}
  const box=$("chatBox"); box.classList.add('fade-out');
  setTimeout(()=>{ box.classList.remove('fade-out'); viewHome(); },600);
}

/* ===== í•˜ë‹¨ ë²„íŠ¼ ===== */
$("homeBtn").onclick = ()=>viewHome();
$("backBtn").onclick = ()=>{
  if(selectedType==="ê¸°ì¶œ"){ viewHome(); return; }
  if(currentPage==="result"){ viewType(selectedType); }
  else{ viewHome(); }
};

/* ===== í•˜íŠ¸ â†’ ë¹„ë°€ë²ˆí˜¸(í´ë¼ì´ì–¸íŠ¸ í•´ì‹œ ë¹„êµ) ===== */
const modal = $("passwordModal"), pass = $("adminPass");
$("heartBtn").onclick = ()=>{ modal.style.display="flex"; pass.value=""; pass.focus(); };
$("pwCancelBtn").onclick = ()=>{ modal.style.display="none"; };
$("pwConfirmBtn").onclick = checkPassword;
pass.addEventListener('keydown',e=>{ if(e.key==="Enter"){ e.preventDefault(); checkPassword(); } });

/* SHA-256 ìœ í‹¸ */
function buf2hex(buf){ return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join(""); }

async function checkPassword(){
  const raw = pass.value;
  if(!raw){ alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
  const enc = new TextEncoder().encode(raw);
  const digest = await crypto.subtle.digest("SHA-256", enc);
  const hex = buf2hex(digest);
  if(hex === ADMIN_PW_SHA256){
    modal.style.display="none";
    loadAdmin(); // ê´€ë¦¬ì í™”ë©´ ë¡œë“œ
  }else{
    alert("ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.");
  }
}

/* ===== ê´€ë¦¬ì í™”ë©´: ë°©ë¬¸ì ìˆ˜ + ìµœê·¼ ë¦¬ë·° ===== */
async function loadAdmin(){
  try{
    const stats = await fetch(`${SCRIPT_URL}?action=stats`).then(r=>r.json());
    const reviews = await fetch(`${SCRIPT_URL}?action=read`).then(r=>r.json());
    renderAdmin(stats, reviews);
  }catch(e){
    alert("ê´€ë¦¬ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

function renderAdmin(stats, reviews){
  chat().innerHTML = `
    <div>
      <h3>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
      <div class="card" style="display:flex;gap:12px;justify-content:space-between;align-items:center">
        <div><b>ì´ ë°©ë¬¸</b><br><span class="p">${Number(stats?.visits||0).toLocaleString()}</span></div>
        <div><b>ê³ ìœ  ì‚¬ìš©ì</b><br><span class="p">${Number(stats?.uniqueSessions||0).toLocaleString()}</span></div>
      </div>
      <div style="margin-top:8px">
        ${reviews.slice(-12).reverse().map(r=>`
          <div class="card">
            <b>${r.type||''}</b> ${r.level?`${r.level}ë‹¨ê³„`:''}<br/>
            ${r.review||''}<br/>
            <small class="p">${r.datetime||''}${r.session?` Â· ì„¸ì…˜:${r.session}`:''}</small>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  scrollTop();
}

/* ë¶€íŠ¸ */
viewHome();
</script>
</body>
</html>
