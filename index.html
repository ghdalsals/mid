<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë¬¸ì œì§‘ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜</title>
<style>
/* âœ… ì¢Œìš° ìŠ¤í¬ë¡¤ ì™„ì „ ì°¨ë‹¨ + ë°•ìŠ¤ì‚¬ì´ì§• í†µì¼ */
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow-x:hidden;-webkit-text-size-adjust:100%}

:root{
  --bg:#f4f4f4;--chat-bg:#fff;--text:#1d1d1f;
  --btn:#e0e0e0;--btn-h:#d4d4d4;--btn-a:#c7c7c7;--bd:#ccc;
  --radius:18px;--shadow:0 6px 20px rgba(0,0,0,.08)
}
body{
  background:var(--bg);
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Noto Sans KR",sans-serif;
  display:flex;justify-content:center;align-items:center;min-height:100vh
}
.chat-container{
  width:min(440px,92vw);
  height:min(640px,92vh);
  background:var(--chat-bg);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:22px;
  display:flex;flex-direction:column;
  transition:opacity .6s ease
}
.fade-out{opacity:0;pointer-events:none}
#chat-content{
  flex:1;overflow-y:auto;overflow-x:hidden;
  scroll-behavior:smooth;color:var(--text);font-size:1rem
}
h3{margin:0 0 14px 0;font-size:1.1rem;text-align:center}
.button{
  background:var(--btn);color:var(--text);border:1px solid var(--bd);
  border-radius:var(--radius);padding:14px;margin:10px 0;
  font-size:1.05rem;cursor:pointer;transition:all .25s ease;width:100%
}
.button:hover{background:var(--btn-h);transform:translateY(-1px)}
.button:active{background:var(--btn-a);transform:scale(.98)}
.bottom-bar{
  display:flex;gap:10px;margin-top:10px
}
/* âœ… í•˜ë‹¨ë°” ë²„íŠ¼ì€ ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ê· ë“± ë¶„í• , ì ˆëŒ€ ë„˜ì¹˜ì§€ ì•ŠìŒ */
.bottom-bar .button{
  width:auto;flex:1;min-width:0;margin:0
}

.review-card{
  background:#f9f9f9;border-radius:12px;padding:10px;margin:8px 0;
  box-shadow:0 2px 6px rgba(0,0,0,.05)
}

/* í‰ê°€(ë¼ë””ì˜¤ ê¸°ë°˜ ì´ëª¨ì§€) */
.rating-group{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:10px;justify-items:center;align-items:center}
.rating-group input{position:absolute;opacity:0;width:0;height:0}
.emoji-label{font-size:2.2rem;cursor:pointer;display:inline-block;transform:scale(1);transition:transform .2s ease, filter .2s ease}
.rating-group input:checked + .emoji-label{transform:scale(1.25);filter:drop-shadow(0 0 6px rgba(0,0,0,.3))}
@keyframes bounce{0%{transform:scale(1)}35%{transform:scale(1.35)}70%{transform:scale(0.9)}100%{transform:scale(1.25)}}
.pulse{animation:bounce .32s cubic-bezier(.25,.46,.45,.94)}

textarea{
  width:100%;max-width:100%;
  border-radius:12px;padding:10px;border:1px solid #bbb;
  resize:none;font-size:.95rem;background:#fafafa;color:#000
}

/* ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬: ì¤‘ì•™, ì¢Œìš°ëŒ€ì¹­, Enter ì§€ì› */
#passwordModal{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  display:none;justify-content:center;align-items:center;padding:16px
}
.modal-box{
  background:#fff;padding:18px;border-radius:15px;
  box-shadow:0 4px 15px rgba(0,0,0,.3);width:min(360px,94vw)
}
.modal-title{margin:0 0 10px 0;text-align:center;font-weight:600}
.modal-row{display:flex;gap:10px;margin-top:10px}
.modal-row .button{margin:0;flex:1}
.modal-input{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;font-size:1rem;text-align:center}
</style>
</head>
<body>
<div class="chat-container" id="chatBox">
  <div id="chat-content"></div>
  <div class="bottom-bar">
    <button class="button" id="backBtn">â†</button>
    <button class="button" id="homeBtn">âŒ‚</button>
    <button class="button" id="heartBtn">ğŸ’–</button>
  </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ -->
<div id="passwordModal" aria-modal="true" role="dialog">
  <div class="modal-box">
    <h3 class="modal-title">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
    <input type="password" id="adminPass" class="modal-input" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password">
    <div class="modal-row" style="margin-top:12px">
      <button class="button" id="pwConfirmBtn">í™•ì¸</button>
      <button class="button" id="pwCancelBtn">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbypbNF4_cfeeRuscpeg6WcNMr1pM3S6Pz_XBoY6UCBOTKIRqSF_gqIau6RkkQpT-MCp/exec";
if(!localStorage.getItem("sessionId")) localStorage.setItem("sessionId","sess-"+Math.random().toString(36).slice(2,11));
const SESSION_ID=localStorage.getItem("sessionId");
fetch(`${SCRIPT_URL}?action=visit&session=${SESSION_ID}`);

const data={
  "ê°œë…ì„œ":{1:["ìˆ˜í•™ì˜ ë°”ì´ë¸”","ë§ˆí”Œ êµê³¼ì„œ","ìˆ˜í•™ì˜ ì™•ë„","ì˜¬ë¦¼í¬ìŠ¤ ìˆ˜í•™","ê°œë… í”ŒëŸ¬ìŠ¤ ìœ í˜• ê³ ë“± ìˆ˜í•™","ì´ìœ ìˆëŠ” ìˆ˜í•™ ê°œë… SOS","ì…€íŒŒ í•´ë²•ìˆ˜í•™"],2:["ìˆ˜í•™ì˜ ìƒ˜","ê°œë… ìˆ","í’ì‚°ì","ê°œë…ì›ë¦¬"],3:["ê¸°ë³¸ ìˆ˜í•™ì˜ ì •ì„","ìˆ˜í•™ì¤‘ì‹¬ ê³ ë“±ìˆ˜í•™","ë©”ê°€ìŠ¤í„°ë”” ë¬¸ì œ ê¸°ë³¸ì„œ CPRìˆ˜í•™","ë” ê°œë… ë¸”ë™ë¼ë²¨"],4:["ì‹¤ë ¥ ìˆ˜í•™ì˜ ì •ì„","ìˆ¨ë§ˆì¿°ë¼ìš°ë°"]},
  "ìœ í˜• ì‹¬í™”ì„œ":{1:["ìˆ˜ë ¥ì¶©ì „","ìˆ˜í•™ì˜ ë°”ì´ë¸” BOB","ê°œë… í”ŒëŸ¬ìŠ¤ ìœ í˜• ë¼ì´íŠ¸","ë¼ì´íŠ¸ ìˆ","ìœ í˜• í•´ê²°ì˜ ë²•ì¹™","ì˜¬ë¦¼í¬ìŠ¤ ë‹¥í„°ë§"],2:["ê°œë…ì›ë¦¬ RPM","í’ì‚°ì í•„ìˆ˜ìœ í˜•","ë‚´ê³µì˜ í˜","ì˜¬ë¦¬ë“œ","í•˜ì´ë¼ì´íŠ¸ ë‹¨ê¸° íŠ¹ê°•","ì‹¬í”Œ ìì´ìŠ¤í† ë¦¬"],3:["ìˆ ìˆ˜í•™","ë§ˆí”Œ ì‹œë„ˆì§€","ì¼ë“±ê¸‰ ìˆ˜í•™","1ë“±ê¸‰ ë§Œë“¤ê¸°"],4:["ì¼í’ˆ","ìš¸ë¦¼í¬ìŠ¤ ê³ ë‚œë„","ìˆ˜ëŠ¥ë‹¤í","ì ˆëŒ€ë“±ê¸‰","ìœ í˜•+ë‚´ì‹  ê³ ìŸì´","ë¸”ë™ë¼ë²¨","ë‚´ì‹  í•˜ì´ì•¤ë“œ","í˜„ìš°ì§„ ë‰´ëŸ°-ì‹œëƒ…ìŠ¤","ìˆ˜í•™ì˜ ì‹ "],5:["TOT","531 í•˜ì´í¼","ì ˆëŒ€ë“±ê¸‰ ì½”ë“œì— ","í˜„ìš°ì§„ ë“œë¦´"]},
  "ê¸°ì¶œ":["ìì´ìŠ¤í† ë¦¬","ì§± ì–´ë ¤ìš´ ìœ í˜• ê³ ë‚œë„ 4ì ì§œë¦¬ ìˆ˜í•™","ë„ˆí¬ë“¤ì˜ ê¸°ì¶œë¬¸ì œ","ë§ˆí”Œ ìˆ˜ëŠ¥ê¸°ì¶œì´ì •ë¦¬","ìˆ˜ëŠ¥ ê¸°ì¶œì˜ ë°”ì´ë¸”","ì‹¤ì „+ìˆ˜ëŠ¥ ê³ ìŸì´","ì–´ì‚¼ì‰¬ì‚¬","ë„ˆê¸°ì¶œ","ìˆ˜ëŠ¥ ê¸°ì¶œì˜ ë¯¸ë˜","ìˆ ê¸°ì¶œ","í‹°ì˜¤í”¼ í´ë˜ìŠ¤ ìˆ˜ëŠ¥ ê¸°ì¶œë¬¸ì œì§‘","ì´ë™í›ˆ ê¸°ì¶œë¬¸ì œì§‘","ë‹´ê¸ˆì§ˆ","ë°±ë¯¸","ê¸°ì¶œì˜ ê³ ë°±","ë§ˆë”í……","ì˜¬ë¦¼í¬ìŠ¤ ê¸°ì¶œë¬¸ì œì§‘"]
};

let satisfaction="",selectedType="",selectedLevel="",currentPage="home";

function loadHome(){
  currentPage="home"; satisfaction="";
  const c=document.getElementById("chat-content");
  c.innerHTML=`
    <div>
      <h3>ì–´ë–¤ ë¬¸ì œì§‘ ì¶”ì²œì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h3>
      <button class="button" onclick="selectType('ê°œë…ì„œ')">ê°œë…ì„œ</button>
      <button class="button" onclick="selectType('ìœ í˜• ì‹¬í™”ì„œ')">ìœ í˜• ì‹¬í™”ì„œ</button>
      <button class="button" onclick="selectType('ê¸°ì¶œ')">ê¸°ì¶œ</button>
    </div>`;
}

function selectType(t){
  currentPage="type"; selectedType=t;
  const c=document.getElementById("chat-content");
  if(t==="ê°œë…ì„œ"){
    c.innerHTML=`<h3>${t} ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>`+[1,2,3,4].map(i=>`<button class="button" onclick="showRecommend(${i})">${i}ë‹¨ê³„</button>`).join('');
  }else if(t==="ìœ í˜• ì‹¬í™”ì„œ"){
    c.innerHTML=`<h3>${t} ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>`+[1,2,3,4,5].map(i=>`<button class="button" onclick="showRecommend(${i})">${i}ë‹¨ê³„</button>`).join('');
  }else{
    showRecommend();
  }
}

function showRecommend(lv){
  currentPage="result"; selectedLevel=lv||""; satisfaction="";
  const c=document.getElementById("chat-content");
  const books=(selectedType==="ê¸°ì¶œ")?data["ê¸°ì¶œ"]:data[selectedType][selectedLevel];
  c.innerHTML=`
    <div>
      <h3>ì¶”ì²œ ë¬¸ì œì§‘ ëª©ë¡</h3>
      ${books.map(b=>`<div class="review-card">${b}</div>`).join('')}
      <button class="button" id="evalBtn">í‰ê°€í•˜ê¸°</button>
    </div>`;
  document.getElementById('evalBtn').onclick=openEvaluation;
}

function openEvaluation(){
  if(document.getElementById("evalSection")){
    document.getElementById("evalSection").scrollIntoView({behavior:'smooth',block:'start'});
    return;
  }
  const chat=document.getElementById("chat-content");
  chat.insertAdjacentHTML('beforeend', `
    <div id="evalSection">
      <h3>ì´ ì¶”ì²œì— ì–¼ë§ˆë‚˜ ë§Œì¡±í•˜ì‹œë‚˜ìš”?</h3>
      <div class="rating-group" id="ratingGroup">
        <input id="rate1" type="radio" name="satisfaction" value="ë¶ˆë§Œì¡±"><label class="emoji-label" for="rate1">ğŸ˜¡</label>
        <input id="rate2" type="radio" name="satisfaction" value="ì¡°ê¸ˆ ë¶ˆë§Œì¡±"><label class="emoji-label" for="rate2">ğŸ˜•</label>
        <input id="rate3" type="radio" name="satisfaction" value="ë³´í†µ"><label class="emoji-label" for="rate3">ğŸ˜</label>
        <input id="rate4" type="radio" name="satisfaction" value="ë§Œì¡±"><label class="emoji-label" for="rate4">ğŸ™‚</label>
        <input id="rate5" type="radio" name="satisfaction" value="ë§¤ìš° ë§Œì¡±"><label class="emoji-label" for="rate5">ğŸ˜</label>
      </div>
      <div id="reviewBox" style="margin-top:10px;">
        <textarea id="reviewText" rows="3" placeholder="ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
        <button class="button" onclick="submitReview()">ì œì¶œ</button>
      </div>
    </div>
  `);

  const radios=[...document.querySelectorAll('input[name="satisfaction"]')];
  function pulseLabelById(id){
    const lab=document.querySelector(`label[for="${id}"]`);
    if(!lab) return;
    lab.classList.remove('pulse'); void lab.offsetWidth; lab.classList.add('pulse');
  }
  radios.forEach(r=>{
    r.addEventListener('change',e=>{
      satisfaction=e.target.value;
      pulseLabelById(e.target.id);
    });
  });

  chat.scrollTop=chat.scrollHeight;
}

async function submitReview(){
  const text=(document.getElementById("reviewText")?.value||"").trim();
  if(!satisfaction) return alert("ë§Œì¡±ë„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
  if(!text) return alert("ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
  await fetch(`${SCRIPT_URL}?action=review&type=${selectedType}&level=${selectedLevel}&review=${encodeURIComponent("["+satisfaction+"] "+text)}&session=${SESSION_ID}`);
  const box=document.getElementById('chatBox');
  box.classList.add('fade-out');
  setTimeout(()=>{ box.classList.remove('fade-out'); loadHome(); },600);
}

/* â–¼ í•˜íŠ¸ â†’ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ (ì¢Œìš°ëŒ€ì¹­ + Enter=í™•ì¸) */
const modal=document.getElementById("passwordModal");
const passInput=document.getElementById("adminPass");
document.getElementById("heartBtn").onclick=()=>{ modal.style.display="flex"; passInput.value=""; passInput.focus(); };
document.getElementById("pwCancelBtn").onclick=()=>{ modal.style.display="none"; };
document.getElementById("pwConfirmBtn").onclick=checkPassword;
/* âœ… Enter í‚¤ë¡œ í™•ì¸ ì‹¤í–‰ */
passInput.addEventListener('keydown',(e)=>{
  if(e.key==="Enter"){ e.preventDefault(); checkPassword(); }
});
function checkPassword(){
  const pw=passInput.value.trim();
  if(pw==="0411"){ modal.style.display="none"; loadReviews(); }
  else alert("ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.");
}
async function loadReviews(){
  const res=await fetch(`${SCRIPT_URL}?action=read`);
  const reviews=await res.json();
  const c=document.getElementById("chat-content");
  const total=reviews.length;
  const avg=calcAverage(reviews.map(r=>r.review));
  c.innerHTML=`<h3>ğŸ“Š ìµœê·¼ í‰ê°€ (${total}ê°œ, í‰ê· : ${avg})</h3>`;
  reviews.slice(-10).reverse().forEach(r=>{
    c.innerHTML+=`<div class="review-card"><b>${r.type}</b> ${r.level?`${r.level}ë‹¨ê³„`:''}<br>${r.review}<br><small>${r.datetime}</small></div>`;
  });
  c.scrollTop=0;
}
function calcAverage(arr){
  const map={ë¶ˆë§Œì¡±:1,"ì¡°ê¸ˆ ë¶ˆë§Œì¡±":2,ë³´í†µ:3,ë§Œì¡±:4,"ë§¤ìš° ë§Œì¡±":5};
  const vals=arr.map(t=>{const m=t.match(/\[(.*?)\]/);return m&&map[m[1]]?map[m[1]]:null;}).filter(Boolean);
  return vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1):"ë°ì´í„° ì—†ìŒ";
}

/* â–¼ ë˜ëŒì•„ê°€ê¸° / ì²˜ìŒìœ¼ë¡œ (ê¸°ì¶œ ì˜ˆì™¸ í¬í•¨) */
document.getElementById("homeBtn").onclick=()=>loadHome();
document.getElementById("backBtn").onclick=()=>{
  if(selectedType==="ê¸°ì¶œ"){ loadHome(); return; }
  if(currentPage==="result") selectType(selectedType);
  else loadHome();
};

loadHome();
</script>
</body>
</html>
