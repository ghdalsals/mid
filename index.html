<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¬¸ì œì§‘ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜</title>
<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow-x:hidden;-webkit-text-size-adjust:100%}
:root{
  --bg:#ffffff; --fg:#1d1d1f; --muted:#6e6e73; --line:#d2d2d7; --elev:#f5f5f7;
  --radius:20px; --space:22px; --shadow:0 14px 40px rgba(0,0,0,.08);
  --ease: cubic-bezier(.25,.46,.45,.94);
  --speed:.28s;
  --card-anim: 220ms;   /* ì¹´ë“œ ì „í™˜ í†µì¼ */
  --page-anim: 260ms;   /* í™”ë©´(step) ì „í™˜ í†µì¼ (iOS ìŠ¬ë¼ì´ë“œ) */
}

/* ë ˆì´ì•„ì›ƒ */
body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Noto Sans KR",system-ui,Segoe UI,Roboto,sans-serif;
  color:var(--fg); background:var(--bg);
  display:flex;align-items:center;justify-content:center;
  padding: clamp(18px, 4vw, 36px);
}

/* âœ… ì‹¤ì œ ìŠ¤ë§ˆíŠ¸í° ë¹„ìœ¨: ê¸°ë³¸ 9:19.5, ë°ìŠ¤í¬í†± ìº¡, ëª¨ë°”ì¼ svh ê½‰ ì±„ì›€ */
.chat{
  width: clamp(360px, 92vw, 430px);
  aspect-ratio: 9 / 19.5;
  height: auto;
  max-height: min(820px, calc(100svh - 24px));
  background:#fff; border:1px solid var(--line);
  border-radius:var(--radius); box-shadow:var(--shadow);
  display:flex; flex-direction:column; overflow:hidden; transition:opacity .6s var(--ease)
}
@media (max-width: 600px){
  body{ padding:12px; }
  .chat{
    width: 100%;
    height: calc(100svh - 24px);
    aspect-ratio: auto;
    border-radius: 18px;
  }
}
@media (min-width: 900px){
  .chat{ aspect-ratio: 10 / 17; } /* ë°ìŠ¤í¬í†± ê¸¸ì­‰í•¨ ì™„í™” */
}

.header{ padding: calc(var(--space) - 4px) var(--space) var(--space); border-bottom:1px solid var(--line) }
.title{ margin:0; font-size:22px; font-weight:600; letter-spacing:-.02em; text-align:center }
#chat-content{ flex:1; padding: var(--space); overflow-y:auto; overflow-x:hidden; scroll-behavior:smooth }
h3{margin:0 0 14px 0; font-size:18px; font-weight:600; text-align:center}
.p{margin:0; color:var(--muted); font-size:16.5px}

/* ë²„íŠ¼ */
.button{
  display:block; width:100%; border:1px solid var(--line); background:var(--elev); color:var(--fg);
  border-radius:14px; padding:14px 16px; font-size:17px; font-weight:600; letter-spacing:-.01em; margin:10px 0;
  transition:transform var(--speed) var(--ease), filter var(--speed) var(--ease), background var(--speed) var(--ease); cursor:pointer
}
.button:hover{ transform:translateY(-1px); filter:brightness(1.02) }
.button:active{ transform:translateY(0); filter:brightness(.98) }

/* CTA(í‰ê°€í•˜ê¸°/ì œì¶œ) â€” ìš”ì²­: ì¹´ë“œë³´ë‹¤ ì§„í•˜ê²Œ */
.button.cta{
  background:#c7c7ce;    /* ì‚´ì§ ë” ì§„í•œ íšŒìƒ‰ */
  color:#1d1d1f;
  border-color:#bdbdc4;
}
.button.cta:hover{
  transform:translateY(-1px);
  background:#d2d2d9;
  filter:none;
}
.button.cta:active{
  transform:translateY(0);
  background:#bfbfc7;
  filter:none;
}

/* í•˜ë‹¨ë°” */
.bottom{ display:flex; gap:10px; padding: var(--space); border-top:1px solid var(--line) }
.bottom .button{ margin:0; flex:1; min-width:0; text-align:center }

/* ì¶”ì²œ ì¹´ë“œ: í´ë¦­/ì„ íƒ ìƒ‰ ë” ì—°í•˜ê²Œ + ì „í™˜ ì†ë„ í†µì¼ */
.card{
  background:var(--elev); border:1px solid var(--line); border-radius:14px;
  padding:12px 14px; font-size:16px; margin:8px 0; cursor:pointer;
  transition:
    background-color var(--card-anim) var(--ease),
    transform        var(--card-anim) var(--ease),
    box-shadow       var(--card-anim) var(--ease),
    opacity          var(--card-anim) var(--ease);
}
.card:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.06) }
.card:active{ transform:scale(.99) }
.card.clicked{  background:#f0f0f3; }  /* ì§§ì€ í´ë¦­ í”¼ë“œë°±(ì—°í•¨) */
.card.selected{ background:#e9e9ee; }  /* ë‹¨ì¼ ì„ íƒ ìœ ì§€(ì—°í•¨) */

/* ë§Œì¡±ë„ ë¼ë””ì˜¤ */
.rating{ display:grid; grid-template-columns:repeat(5,1fr); gap:12px; margin-top:12px; justify-items:center; align-items:center }
.rating input{ position:absolute; opacity:0; width:0; height:0 }
.emoji{ font-size:2.2rem; line-height:1; display:inline-block; cursor:pointer; transform:scale(1);
  transition:transform .2s var(--ease), filter .2s var(--ease) }
.rating input:checked + .emoji{ transform:scale(1.24); filter:drop-shadow(0 0 6px rgba(0,0,0,.25)) }
@keyframes bounce{0%{transform:scale(1)}35%{transform:scale(1.34)}70%{transform:scale(0.92)}100%{transform:scale(1.24)}}
.pulse{ animation:bounce .32s var(--ease) }

/* textarea */
textarea{ width:100%; max-width:100%; border:1px solid var(--line); background:#fff; border-radius:12px;
  padding:12px; font-size:16px; line-height:1.5; resize:none; color:var(--fg) }

/* ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ */
.modal{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.4); align-items:center; justify-content:center; padding:16px }
.modal-box{ width:min(420px,94vw); background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:18px }
.modal h4{ margin:0 0 12px 0; font-size:18px; text-align:center; font-weight:600 }
.input{ width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px; font-size:16px; text-align:center }
.modal-row{ display:flex; gap:10px; margin-top:12px }
.modal-row .button{ margin:0; flex:1 }

/* í† ìŠ¤íŠ¸ */
.toast{
  margin-top:10px; text-align:center; font-weight:600;
  background:#f5f5f7; border:1px solid var(--line); border-radius:10px; padding:10px;
  animation: fadein .2s var(--ease);
}
@keyframes fadein{ from{opacity:0} to{opacity:1} }

/* =========================
   iOS ìŠ¤íƒ€ì¼ 'ìŠ¬ë¼ì´ë“œ' ì „í™˜
   ========================= */
.view{ will-change: transform, opacity; }

/* ìƒˆ í™”ë©´ ì§„ì… */
.slide-enter{ transform: translateX(12%); opacity:0; }
.slide-enter-active{
  transform: translateX(0); opacity:1;
  transition: transform var(--page-anim) var(--ease), opacity var(--page-anim) var(--ease);
}

/* ì´ì „ í™”ë©´ ì´íƒˆ */
.slide-leave{ transform: translateX(0); opacity:1; }
.slide-leave-active{
  transform: translateX(-8%); opacity:0;
  transition: transform var(--page-anim) var(--ease), opacity var(--page-anim) var(--ease);
}

/* ì ‘ê·¼ì„±: ëª¨ì…˜ ìµœì†Œí™” */
@media (prefers-reduced-motion: reduce){
  .slide-enter, .slide-leave{ transform:none !important; }
}
</style>
</head>
<body>
  <div class="chat" id="chatBox">
    <div class="header"><h1 class="title">ë¬¸ì œì§‘ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜</h1></div>
    <div id="chat-content"></div>

    <div class="bottom" role="group" aria-label="í•˜ë‹¨ ë„êµ¬">
      <button class="button" id="backBtn"  aria-label="ë˜ëŒì•„ê°€ê¸°" title="ë˜ëŒì•„ê°€ê¸°">â†</button>
      <button class="button" id="homeBtn"  aria-label="ì²˜ìŒìœ¼ë¡œ"   title="ì²˜ìŒìœ¼ë¡œ">âŒ‚</button>
      <button class="button" id="heartBtn" aria-label="ê´€ë¦¬ì"     title="ê´€ë¦¬ì">ğŸ’–</button>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div class="modal" id="passwordModal" aria-modal="true" role="dialog">
    <div class="modal-box">
      <h4>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h4>
      <input id="adminPass" class="input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
      <div class="modal-row">
        <button class="button cta" id="pwConfirmBtn">í™•ì¸</button>
        <button class="button" id="pwCancelBtn">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

<script>
/* ===== ì„¤ì • ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyZR-TvpidGXhYob4xq__WzfKOVZlroRt5Alf0SnRPswZ2d2zKh0SglgyyxP-0XXzWk/exec";
/* í‰ë¬¸ ëŒ€ì‹  SHA-256 í•´ì‹œë§Œ ì½”ë“œì— ì €ì¥ (ë¹„ë²ˆ 0411 í•´ì‹œ) */
const ADMIN_PW_SHA256 = "d20bdc364b3d7dfdcd81be5a3fd192d0f513fa79e92463bf0ed9efd2f46c243b";

/* ===== ì„¸ì…˜ & ë°©ë¬¸ ===== */
if(!localStorage.getItem("sessionId")) localStorage.setItem("sessionId","sess-"+Math.random().toString(36).slice(2,11));
const SESSION_ID = localStorage.getItem("sessionId");
fetch(`${SCRIPT_URL}?action=visit&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});

/* ===== Haptics (Androidë§Œ) ===== */
const canVibrate = typeof navigator !== "undefined" && typeof navigator.vibrate === "function";
const haptic = {
  light(){ if (canVibrate) navigator.vibrate(8); },
  medium(){ if (canVibrate) navigator.vibrate([12]); },
  success(){ if (canVibrate) navigator.vibrate([10,40,10]); },
  error(){ if (canVibrate) navigator.vibrate([20,50,20]); }
};

/* ===== ë°ì´í„° ===== */
const data = {
  "ê°œë…ì„œ": {
    1:["ìˆ˜í•™ì˜ ë°”ì´ë¸”","ë§ˆí”Œ êµê³¼ì„œ","ìˆ˜í•™ì˜ ì™•ë„","ì˜¬ë¦¼í¬ìŠ¤ ìˆ˜í•™","ê°œë… í”ŒëŸ¬ìŠ¤ ìœ í˜• ê³ ë“± ìˆ˜í•™","ì´ìœ ìˆëŠ” ìˆ˜í•™ ê°œë… SOS","ì…€íŒŒ í•´ë²•ìˆ˜í•™"],
    2:["ìˆ˜í•™ì˜ ìƒ˜","ê°œë… ìˆ","í’ì‚°ì","ê°œë…ì›ë¦¬"],
    3:["ê¸°ë³¸ ìˆ˜í•™ì˜ ì •ì„","ìˆ˜í•™ì¤‘ì‹¬ ê³ ë“±ìˆ˜í•™","ë©”ê°€ìŠ¤í„°ë”” ë¬¸ì œ ê¸°ë³¸ì„œ CPRìˆ˜í•™","ë” ê°œë… ë¸”ë™ë¼ë²¨"],
    4:["ì‹¤ë ¥ ìˆ˜í•™ì˜ ì •ì„","ìˆ¨ë§ˆì¿°ë¼ìš°ë°"]
  },
  "ìœ í˜• ì‹¬í™”ì„œ": {
    1:["ìˆ˜ë ¥ì¶©ì „","ìˆ˜í•™ì˜ ë°”ì´ë¸” BOB","ê°œë… í”ŒëŸ¬ìŠ¤ ìœ í˜• ë¼ì´íŠ¸","ë¼ì´íŠ¸ ìˆ","ìœ í˜• í•´ê²°ì˜ ë²•ì¹™","ì˜¬ë¦¼í¬ìŠ¤ ë‹¥í„°ë§"],
    2:["ê°œë…ì›ë¦¬ RPM","í’ì‚°ì í•„ìˆ˜ìœ í˜•","ë‚´ê³µì˜ í˜","ì˜¬ë¦¬ë“œ","í•˜ì´ë¼ì´íŠ¸ ë‹¨ê¸° íŠ¹ê°•","ì‹¬í”Œ ìì´ìŠ¤í† ë¦¬"],
    3:["ìˆ ìˆ˜í•™","ë§ˆí”Œ ì‹œë„ˆì§€","ì¼ë“±ê¸‰ ìˆ˜í•™","1ë“±ê¸‰ ë§Œë“¤ê¸°"],
    4:["ì¼í’ˆ","ìš¸ë¦¼í¬ìŠ¤ ê³ ë‚œë„","ìˆ˜ëŠ¥ë‹¤í","ì ˆëŒ€ë“±ê¸‰","ìœ í˜•+ë‚´ì‹  ê³ ìŸì´","ë¸”ë™ë¼ë²¨","ë‚´ì‹  í•˜ì´ì•¤ë“œ","í˜„ìš°ì§„ ë‰´ëŸ°-ì‹œëƒ…ìŠ¤","ìˆ˜í•™ì˜ ì‹ "],
    5:["TOT","531 í•˜ì´í¼","ì ˆëŒ€ë“±ê¸‰ ì½”ë“œì— ","í˜„ìš°ì§„ ë“œë¦´"]
  },
  "ê¸°ì¶œ": ["ìì´ìŠ¤í† ë¦¬","ì§± ì–´ë ¤ìš´ ìœ í˜• ê³ ë‚œë„ 4ì ì§œë¦¬ ìˆ˜í•™","ë„ˆí¬ë“¤ì˜ ê¸°ì¶œë¬¸ì œ","ë§ˆí”Œ ìˆ˜ëŠ¥ê¸°ì¶œì´ì •ë¦¬","ìˆ˜ëŠ¥ ê¸°ì¶œì˜ ë°”ì´ë¸”","ì‹¤ì „+ìˆ˜ëŠ¥ ê³ ìŸì´","ì–´ì‚¼ì‰¬ì‚¬","ë„ˆê¸°ì¶œ","ìˆ˜ëŠ¥ ê¸°ì¶œì˜ ë¯¸ë˜","ìˆ ê¸°ì¶œ","í‹°ì˜¤í”¼ í´ë˜ìŠ¤ ìˆ˜ëŠ¥ ê¸°ì¶œë¬¸ì œì§‘","ì´ë™í›ˆ ê¸°ì¶œë¬¸ì œì§‘","ë‹´ê¸ˆì§ˆ","ë°±ë¯¸","ê¸°ì¶œì˜ ê³ ë°±","ë§ˆë”í……","ì˜¬ë¦¼í¬ìŠ¤ ê¸°ì¶œë¬¸ì œì§‘"]
};

/* ===== ìƒíƒœ & ìœ í‹¸ ===== */
let satisfaction = "", selectedType = "", selectedLevel = "", currentPage = "home";
let lastClickedBook = "", lastSubmittedBook = "", lastSubmittedAt = "";
const CLICK_MS = 220; // ì¹´ë“œ í´ë¦­/í•´ì œ í”¼ë“œë°± ì‹œê°„(CSSì™€ ì¼ì¹˜)

const $ = id => document.getElementById(id);
const chat = () => $("chat-content");
const scrollTop = () => { chat().scrollTop=0; };
const scrollBottom = () => { chat().scrollTop=chat().scrollHeight; };

/* í™”ë©´ ì „í™˜: iOS ìŠ¬ë¼ì´ë“œ (í†µì¼) */
function swapView(html, klass='slide'){
  const c = chat();
  const old = document.createElement('div');
  old.className = `view ${klass}-leave`;
  old.innerHTML = c.innerHTML;

  const neu = document.createElement('div');
  neu.className = `view ${klass}-enter`;
  neu.innerHTML = html;

  c.innerHTML = '';
  c.appendChild(old);
  c.appendChild(neu);

  requestAnimationFrame(()=>{
    old.classList.add(`${klass}-leave-active`);
    neu.classList.add(`${klass}-enter-active`);
  });

  setTimeout(()=>{ c.innerHTML = ''; c.appendChild(neu); neu.className = 'view'; }, 280);
}

/* ìµœê·¼ ì œì¶œ ì •ë³´ ë¡œì»¬ ì €ì¥/ë³µì› (ê´€ë¦¬ìì—ì„œ í‘œì‹œ) */
function saveLastSubmission(){
  if(!lastClickedBook) return;
  lastSubmittedBook = lastClickedBook;
  lastSubmittedAt = new Date().toISOString();
  localStorage.setItem("lastSubmittedBook", lastSubmittedBook);
  localStorage.setItem("lastSubmittedAt", lastSubmittedAt);
}
function getLastSubmission(){
  return {
    book: localStorage.getItem("lastSubmittedBook") || "(ì„ íƒ ì—†ìŒ)",
    at: localStorage.getItem("lastSubmittedAt") || ""
  };
}

/* ===== í™ˆ ===== */
function viewHome(msg){
  currentPage="home"; satisfaction="";
  const html = `
    <div>
      ${msg ? `
        <div class="banner" role="status">
          ${msg}
          <button class="close" aria-label="ë‹«ê¸°" onclick="this.parentElement.remove()">Ã—</button>
        </div>` : ``}
      <p class="p" style="text-align:center;margin-bottom:14px">ì›í•˜ëŠ” ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”</p>
      <button class="button" onclick="viewType('ê°œë…ì„œ')">ê°œë…ì„œ</button>
      <button class="button" onclick="viewType('ìœ í˜• ì‹¬í™”ì„œ')">ìœ í˜• ì‹¬í™”ì„œ</button>
      <button class="button" onclick="viewType('ê¸°ì¶œ')">ê¸°ì¶œ</button>
    </div>`;
  swapView(html, 'slide');  // iOS ìŠ¬ë¼ì´ë“œ ì „í™˜
}

/* ===== ìœ í˜• ì„ íƒ â†’ ë‚œì´ë„ ===== */
function viewType(t){
  currentPage="type"; selectedType=t;
  fetch(`${SCRIPT_URL}?action=select&type=${encodeURIComponent(t)}&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});
  let html = '';
  if(t==="ê°œë…ì„œ"){
    html = `<h3>${t} ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>` + [1,2,3,4].map(i=>`<button class="button" onclick="viewResult(${i})">${i}ë‹¨ê³„</button>`).join('');
  }else if(t==="ìœ í˜• ì‹¬í™”ì„œ"){
    html = `<h3>${t} ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>` + [1,2,3,4,5].map(i=>`<button class="button" onclick="viewResult(${i})">${i}ë‹¨ê³„</button>`).join('');
  }else{
    // ê¸°ì¶œì€ ë‚œì´ë„ ì—†ì´ ê²°ê³¼ë¡œ
    return viewResult();
  }
  swapView(`<div>${html}</div>`, 'slide');
}

/* ===== ê²°ê³¼(ì±… ë¦¬ìŠ¤íŠ¸ + í† ê¸€ ì„ íƒ) ===== */
function viewResult(lv){
  currentPage="result"; selectedLevel=lv||""; satisfaction="";
  if(selectedType!=="ê¸°ì¶œ"){
    fetch(`${SCRIPT_URL}?action=select&type=${encodeURIComponent(selectedType)}&level=${encodeURIComponent(selectedLevel)}&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});
  }
  const books = (selectedType==="ê¸°ì¶œ")? data["ê¸°ì¶œ"] : data[selectedType][selectedLevel];

  const html = `
    <div>
      <h3>ì¶”ì²œ ë¬¸ì œì§‘</h3>
      <div id="bookList"></div>
      <button class="button cta" id="evalBtn">í‰ê°€í•˜ê¸°</button>
    </div>`;
  swapView(html, 'slide');

  // ë Œë” í›„ ë°”ì¸ë”©
  const listEl = document.getElementById("bookList");
  listEl.innerHTML = books.map((b,i)=>`<div class="card" data-book="${b}" tabindex="0" role="button" aria-label="${b}">${i+1}. ${b}</div>`).join('');

  const clearSelected = () => listEl.querySelectorAll(".card.selected").forEach(n=>n.classList.remove("selected"));
  listEl.querySelectorAll(".card").forEach(el=>{
    const book = el.getAttribute("data-book");
    const handleToggle = ()=>{
      haptic.light();

      // ê³µí†µ í´ë¦­ í”¼ë“œë°±(ì„ íƒ/í•´ì œ ë™ì¼ íƒ€ì´ë°)
      el.classList.add("clicked");
      setTimeout(()=>{ el.classList.remove("clicked"); }, CLICK_MS);

      if(el.classList.contains("selected")){
        // í•´ì œ (ë¡œê·¸ ì „ì†¡ ì—†ìŒ)
        el.classList.remove("selected");
        if(lastClickedBook === book) lastClickedBook = "";
      }else{
        clearSelected();
        el.classList.add("selected");
        lastClickedBook = book;
        fetch(`${SCRIPT_URL}?action=book&type=${encodeURIComponent(selectedType)}&level=${encodeURIComponent(selectedLevel)}&book=${encodeURIComponent(book)}&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});
      }
    };
    el.addEventListener("click", handleToggle);
    el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); handleToggle(); }});
  });

  document.getElementById("evalBtn").onclick = ()=>{ haptic.medium(); openEvaluation(); };
}

/* ===== í‰ê°€ ===== */
function openEvaluation(){
  // í‰ê°€ í™”ë©´ì€ ì¸ë¼ì¸ ì¶”ê°€ ëŒ€ì‹ , ìŠ¬ë¼ì´ë“œ ì „í™˜ìœ¼ë¡œ í†µì¼ê° ìœ ì§€
  const block = `
    <div id="evalSection" style="margin-top:14px">
      <h3>ë§Œì¡±ë„ ì„ íƒ</h3>
      <div class="rating" id="ratingGroup">
        <input id="r1" type="radio" name="s" value="ë¶ˆë§Œì¡±"><label class="emoji" for="r1" title="ë¶ˆë§Œì¡±">ğŸ˜¡</label>
        <input id="r2" type="radio" name="s" value="ì¡°ê¸ˆ ë¶ˆë§Œì¡±"><label class="emoji" for="r2" title="ì¡°ê¸ˆ ë¶ˆë§Œì¡±">ğŸ˜•</label>
        <input id="r3" type="radio" name="s" value="ë³´í†µ"><label class="emoji" for="r3" title="ë³´í†µ">ğŸ˜</label>
        <input id="r4" type="radio" name="s" value="ë§Œì¡±"><label class="emoji" for="r4" title="ë§Œì¡±">ğŸ™‚</label>
        <input id="r5" type="radio" name="s" value="ë§¤ìš° ë§Œì¡±"><label class="emoji" for="r5" title="ë§¤ìš° ë§Œì¡±">ğŸ˜</label>
      </div>
      <div style="margin-top:12px">
        <textarea id="reviewText" rows="3" placeholder="ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..."></textarea>
        <button class="button cta" style="margin-top:10px" id="submitBtn">ì œì¶œ</button>
        <div id="thanksToast" class="toast" style="display:none;">âœ… í‰ê°€ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ™</div>
      </div>
    </div>
  `;

  // í˜„ì¬ ê²°ê³¼ í™”ë©´ì˜ ìƒë‹¨ë„ í¬í•¨í•´ì„œ í•˜ë‚˜ì˜ ë·°ë¡œ êµ¬ì„±
  const header = `<h3>ì¶”ì²œ ë¬¸ì œì§‘</h3>`;
  let items = '';
  const books = (selectedType==="ê¸°ì¶œ")? data["ê¸°ì¶œ"] : data[selectedType][selectedLevel];
  items = books.map((b,i)=>`<div class="card ${lastClickedBook===b?'selected':''}" data-book="${b}" tabindex="0" role="button" aria-label="${b}">${i+1}. ${b}</div>`).join('');
  const html = `<div>${header}<div id="bookList">${items}</div><button class="button cta" disabled>í‰ê°€í•˜ê¸°</button>${block}</div>`;
  swapView(html, 'slide');

  // ì±… í† ê¸€(í‰ê°€ í™”ë©´ì—ì„œë„ ìœ ì§€)
  const listEl = document.getElementById("bookList");
  const clearSelected = () => listEl.querySelectorAll(".card.selected").forEach(n=>n.classList.remove("selected"));
  listEl.querySelectorAll(".card").forEach(el=>{
    const book = el.getAttribute("data-book");
    const handleToggle = ()=>{
      haptic.light();
      el.classList.add("clicked");
      setTimeout(()=>{ el.classList.remove("clicked"); }, CLICK_MS);

      if(el.classList.contains("selected")){
        el.classList.remove("selected");
        if(lastClickedBook === book) lastClickedBook = "";
      }else{
        clearSelected();
        el.classList.add("selected");
        lastClickedBook = book;
        fetch(`${SCRIPT_URL}?action=book&type=${encodeURIComponent(selectedType)}&level=${encodeURIComponent(selectedLevel)}&book=${encodeURIComponent(book)}&session=${encodeURIComponent(SESSION_ID)}`).catch(()=>{});
      }
    };
    el.addEventListener("click", handleToggle);
    el.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); handleToggle(); }});
  });

  // ì´ëª¨í‹°ì½˜ ì„ íƒ
  const radios=[...document.querySelectorAll('input[name="s"]')];
  const pulse=id=>{ const l=document.querySelector(`label[for="${id}"]`); l.classList.remove('pulse'); void l.offsetWidth; l.classList.add('pulse'); };
  radios.forEach(r=>{ r.addEventListener('change',e=>{ satisfaction=e.target.value; haptic.light(); pulse(e.target.id); }); });
  document.querySelectorAll('.emoji').forEach(l=>{ l.addEventListener('click',()=>{ const id=l.getAttribute('for'); setTimeout(()=>pulse(id),0); }); });

  // ì œì¶œ í•¸ë“¤ëŸ¬
  const ta = document.getElementById("reviewText");
  const submitBtn = document.getElementById("submitBtn");
  const onSubmit = ()=>submitReview();
  submitBtn.addEventListener("click", onSubmit);
  ta.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      onSubmit();
    }
  });

  // í‰ê°€ ì„¹ì…˜ì´ ë³´ì´ë„ë¡ í•˜ë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
  requestAnimationFrame(()=>{
    scrollBottom();
  });
}

async function submitReview(){
  const text = (document.getElementById("reviewText")?.value||"").trim();
  if(!satisfaction){ haptic.error(); return alert("ë§Œì¡±ë„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!"); }
  if(!text){ haptic.error(); return alert("ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); }

  // âœ… ì¦‰ì‹œ â€œê°ì‚¬í•©ë‹ˆë‹¤â€ í† ìŠ¤íŠ¸ í‘œì‹œ + í•˜ë‹¨ ìŠ¤í¬ë¡¤ ê³ ì •
  const toast = document.getElementById("thanksToast");
  toast.style.display = "block";
  requestAnimationFrame(()=>{
    const c = chat();
    c.scrollTop = c.scrollHeight;
    setTimeout(()=>{ c.scrollTop = c.scrollHeight; }, 50);
  });

  // ë²„íŠ¼/ì…ë ¥ ë¹„í™œì„±í™”
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = "ì „ì†¡ ì¤‘â€¦";
  const ta = document.getElementById("reviewText");
  ta.readOnly = true;

  try{
    await fetch(`${SCRIPT_URL}?action=review&type=${encodeURIComponent(selectedType)}&level=${encodeURIComponent(selectedLevel)}&review=${encodeURIComponent("["+satisfaction+"] "+text)}&session=${encodeURIComponent(SESSION_ID)}`);
    saveLastSubmission();
    haptic.success();

    // ì „ì†¡ ì™„ë£Œ í›„ ê³§ë°”ë¡œ í™ˆìœ¼ë¡œ (í™ˆ ë°°ë„ˆ ì—†ìŒ)
    const box=document.getElementById("chatBox"); box.classList.add('fade-out');
    setTimeout(()=>{ box.classList.remove('fade-out'); viewHome(); }, 450);
  }catch(e){
    haptic.error();
    alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    toast.style.display = "none";
    submitBtn.disabled = false;
    submitBtn.textContent = "ì œì¶œ";
    ta.readOnly = false;
  }
}

/* ===== í•˜ë‹¨ ë²„íŠ¼ ===== */
document.getElementById("homeBtn").onclick = ()=>{ haptic.medium(); viewHome(); };
document.getElementById("backBtn").onclick = ()=>{
  haptic.light();
  if(selectedType==="ê¸°ì¶œ"){
    // ê¸°ì¶œì€ í™ˆìœ¼ë¡œ
    viewHome();
  }else if(currentPage==="result"){
    // ê²°ê³¼ â†’ ë‚œì´ë„ ì„ íƒ
    viewType(selectedType);
  }else{
    // ê·¸ ì™¸ â†’ í™ˆ
    viewHome();
  }
};

/* ===== í•˜íŠ¸ â†’ ë¹„ë°€ë²ˆí˜¸(í´ë¼ì´ì–¸íŠ¸ í•´ì‹œ ë¹„êµ) + ê´€ë¦¬ì ===== */
const modal = document.getElementById("passwordModal"), pass = document.getElementById("adminPass");
document.getElementById("heartBtn").onclick = ()=>{
  haptic.medium();
  modal.style.display="flex"; pass.value=""; pass.focus();
};
document.getElementById("pwCancelBtn").onclick = ()=>{ haptic.light(); modal.style.display="none"; };
document.getElementById("pwConfirmBtn").onclick = ()=>{ haptic.medium(); checkPassword(); };
pass.addEventListener('keydown',e=>{
  if(e.key==="Enter"){ e.preventDefault(); haptic.medium(); checkPassword(); }
});

function buf2hex(buf){ return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,"0")).join(""); }
async function checkPassword(){
  const raw = pass.value; if(!raw){ alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
  const enc = new TextEncoder().encode(raw);
  const digest = await crypto.subtle.digest("SHA-256", enc);
  const hex = buf2hex(digest);
  if(hex === ADMIN_PW_SHA256){
    modal.style.display="none";
    loadAdmin();
  }else{
    alert("ì˜ëª»ëœ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.");
  }
}

/* ===== ê´€ë¦¬ì: ë°©ë¬¸/ê³ ìœ /ì¼ì¼ + ìµœê·¼ ì œì¶œ ë¬¸ì œì§‘ ===== */
async function loadAdmin(){
  try{
    const stats = await fetch(`${SCRIPT_URL}?action=stats`).then(r=>r.json());
    const reviews = await fetch(`${SCRIPT_URL}?action=read`).then(r=>r.json());
    const last = getLastSubmission();

    const todayVisits = (typeof stats?.todayVisits !== "undefined") ? Number(stats.todayVisits).toLocaleString() : "-";
    const html = `
      <div>
        <h3>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
        <div class="card" style="margin-bottom:10px">
          <b>ìµœê·¼ ì œì¶œ ë‹¹ì‹œ ì„ íƒí•œ ë¬¸ì œì§‘</b><br/>
          <div class="p" style="margin-top:6px">${last.book}</div>
          ${last.at ? `<small class="p">${new Date(last.at).toLocaleString()}</small>` : ``}
        </div>

        <div class="card" style="display:flex;gap:12px;justify-content:space-between;align-items:center">
          <div><b>ì´ ë°©ë¬¸</b><br><span class="p">${Number(stats?.visits||0).toLocaleString()}</span></div>
          <div><b>ì¼ì¼ ë°©ë¬¸</b><br><span class="p">${todayVisits}</span></div>
          <div><b>ê³ ìœ  ì‚¬ìš©ì</b><br><span class="p">${Number(stats?.uniqueSessions||0).toLocaleString()}</span></div>
        </div>

        <div style="margin-top:8px">
          ${reviews.slice(-12).reverse().map(r=>`
            <div class="card">
              <b>${r.type||''}</b> ${r.level?`${r.level}ë‹¨ê³„`:''}<br/>
              ${r.review||''}<br/>
              <small class="p">${r.datetime||''}${r.session?` Â· ì„¸ì…˜:${r.session}`:''}</small>
            </div>
          `).join('')}
        </div>
      </div>
    `;
    swapView(html, 'slide');
  }catch(e){
    alert("ê´€ë¦¬ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
}

/* ë¶€íŠ¸ */
viewHome();
</script>
</body>
</html>
